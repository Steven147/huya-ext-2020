#!/usr/bin/env node

const path = require('path')
const fse = require('fs-extra')
const commander = require('commander')
const packageJson = require('../package.json')
const readProjectConfig = require('../lib/readProjectConfig')
const ROOT = process.cwd()

const program = new commander.Command(packageJson.name)
  .usage('start')
  .parse(process.argv);

const projectCfg = readProjectConfig()

let builder = require( path.resolve(process.cwd(), 'node_modules', projectCfg.builder.name) )

builder.start({
  projectName: projectCfg.name,
  mode: 'development',
  config: projectCfg.builder.config,
  inputPath: projectCfg.inputPath,
  outputPath: projectCfg.outputPath,
  publicPath: projectCfg.publicPath,
  releasePath: projectCfg.releasePath,
})
  .then((buildResult = {}) => {
    Object.keys(buildResult).forEach(endpoint => {
      if ( buildResult[endpoint] ) {
        const file = path.join(projectCfg.outputPath, 'build-result', `${endpoint}.json`)
        fse.outputJsonSync(file, {[endpoint]: buildResult[endpoint]})
      }
    })
  })
