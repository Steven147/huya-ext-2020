const fs = require('fs-extra')
const path = require('path')
const download = require('download')
const { HINT, ERROR } = require('../utils/utils.js')

const GRADLE_URL = 'https://hd.huya.com/h5/static-source/gradle/gradle-5.2.1-bin.zip'
const GRADLE_DEST = path.resolve(__dirname, 'gradle', 'wrapper')

const HYGAME_PLUGIN_SRC = process.env.HYGAME_PLUGIN_SRC
const HYGAME_PLUGIN_DEST = path.resolve(__dirname, 'hyg-libs')
const HYEXT_GRADLE_ZIP = process.env.HYEXT_GRADLE_ZIP

;(async () => {
  if (!HYGAME_PLUGIN_SRC) {
    // ERROR('没有找到 plugin-hygame-build.jar 的位置, 请定义环境变量 HYGAME_PLUGIN_SRC')
    // process.exit(1)
    return
  }

  try {
    HINT(`发现环境变量 HYGAME_PLUGIN_SRC:  ${HYGAME_PLUGIN_SRC}`)
    HINT(`拷贝 ${HYGAME_PLUGIN_SRC} => ${HYGAME_PLUGIN_DEST}...`)
    fs.copySync(HYGAME_PLUGIN_SRC, HYGAME_PLUGIN_DEST)
    HINT(`拷贝 ${HYGAME_PLUGIN_SRC} => ${HYGAME_PLUGIN_DEST}[success]`)

    if (!fs.existsSync(path.resolve(GRADLE_DEST, path.basename(GRADLE_URL)))) {
      if (HYEXT_GRADLE_ZIP) {
        HINT(`拷贝 ${HYEXT_GRADLE_ZIP} => ${GRADLE_DEST}...`)
        fs.copySync(HYEXT_GRADLE_ZIP, path.resolve(GRADLE_DEST, path.basename(HYEXT_GRADLE_ZIP)))
        HINT(`拷贝 ${HYEXT_GRADLE_ZIP} => ${GRADLE_DEST}[success]`)
      } else {
        HINT(`下载 ${GRADLE_URL}...`)
        await download(GRADLE_URL, GRADLE_DEST)
        HINT(`下载 ${GRADLE_URL}[success]`)
      }
    }
  } catch (err) {
    ERROR(`准备 gradle 失败: ${err.messsage}`)
    process.exit(1)
  }
})();
